import os
import schedule
import time
import random
import subprocess
from datetime import datetime, timedelta
from bs4 import BeautifulSoup
import pytz

# ---------------------------
# Paths & GitHub Config
# ---------------------------
REPO_PATH = "/opt/render/project/src"  # merged repo root
HTML_FILE = os.path.join(REPO_PATH, "index.html")

GITHUB_REPO = "https://github.com/ryan85501/2d-calculation-server.git"
yangon_tz = pytz.timezone("Asia/Yangon")

# ---------------------------
# Git Helper Functions
# ---------------------------
def git_pull():
    subprocess.run(["git", "pull", "origin", "main"], cwd=REPO_PATH)

def git_push():
    subprocess.run(["git", "add", "index.html"], cwd=REPO_PATH)
    subprocess.run(["git", "commit", "-m", "Auto update index.html"], cwd=REPO_PATH)
    subprocess.run(["git", "push", "origin", "main"], cwd=REPO_PATH)

# ---------------------------
# Utility Functions
# ---------------------------
def load_html():
    with open(HTML_FILE, "r", encoding="utf-8") as f:
        return BeautifulSoup(f, "html.parser")

def save_html(soup):
    with open(HTML_FILE, "w", encoding="utf-8") as f:
        f.write(str(soup))

def get_today_str():
    now = datetime.now(yangon_tz)
    return now.strftime("%d-%m-%Y")

def get_next_day_str(skip_weekends=True):
    now = datetime.now(yangon_tz)
    next_day = now + timedelta(days=1)
    if skip_weekends and next_day.weekday() == 5:  # Saturday
        next_day += timedelta(days=2)
    elif skip_weekends and next_day.weekday() == 6:  # Sunday
        next_day += timedelta(days=1)
    return next_day.strftime("%d-%m-%Y")

def get_latest_pm_result():
    soup = load_html()
    history_table = soup.select_one("#history-table-body")
    if not history_table:
        return None
    for row in history_table.find_all("tr"):
        cols = row.find_all("td")
        if len(cols) >= 3 and cols[2].text.strip().isdigit():
            return cols[2].text.strip()
    return None

def get_last_friday_pm_result():
    soup = load_html()
    history_table = soup.select_one("#history-table-body")
    if not history_table:
        return None
    for row in history_table.find_all("tr"):
        cols = row.find_all("td")
        if len(cols) >= 3:
            date_str = cols[0].text.strip()
            try:
                date = datetime.strptime(date_str, "%d-%m-%Y")
                if date.weekday() == 4 and cols[2].text.strip().isdigit():  # Friday
                    return cols[2].text.strip()
            except:
                continue
    return None

# ---------------------------
# Custom Calculation Methods
# ---------------------------
def calculate_one_chain():
    pm_result = get_latest_pm_result()
    if not pm_result:
        return ["-", "-"]
    return list(pm_result[:2])  # first 2 digits of PM

def calculate_not_broken():
    pm_result = get_latest_pm_result()
    if not pm_result:
        return ["-", "-", "-"]
    return list(pm_result[-3:])  # last 3 digits of PM

def calculate_mwe_ga_nan():
    friday_pm = get_last_friday_pm_result()
    if not friday_pm:
        return ["--"] * 5
    base = int(friday_pm)
    return [str((base + i * 7) % 100).zfill(2) for i in range(5)]  # example method

# ---------------------------
# HTML Update Function
# ---------------------------
def update_html(updates=None, new_result=None, period=None, advance_date=False):
    git_pull()
    soup = load_html()

    # Update custom sections
    if updates:
        for key, value in updates.items():
            target = soup.select_one(f'div[data-id="{key}"]')
            if target:
                target.string = ", ".join(value) if isinstance(value, list) else value

    # Add AM/PM results
    if new_result and period in ["am", "pm"]:
        history_table = soup.select_one("#history-table-body")
        today = get_today_str()
        today_row = None

        for row in history_table.find_all("tr"):
            if today in row.text:
                today_row = row
                break

        if not today_row:
            new_row = soup.new_tag("tr")
            date_td = soup.new_tag("td"); date_td.string = today
            am_td = soup.new_tag("td"); pm_td = soup.new_tag("td")
            new_row.extend([date_td, am_td, pm_td])
            history_table.insert(0, new_row)
            today_row = new_row

        tds = today_row.find_all("td")
        if period == "am":
            tds[1].string = new_result
        elif period == "pm":
            tds[2].string = new_result

        prev_container = soup.select_one("#previous-results-container")
        if prev_container:
            result_row = soup.new_tag("div")
            result_row["class"] = "results-row text-4xl font-bold font-serif"
            number_group = soup.new_tag("div")
            number_group["class"] = "number-group"
            for digit in new_result:
                span = soup.new_tag("span")
                span.string = digit
                span["class"] = "digit-span p-1"
                number_group.append(span)
            result_row.append(number_group)
            prev_container.append(result_row)

    # Advance date at 8:01 PM
    if advance_date:
        date_span = soup.select_one("#current-date")
        if date_span:
            next_date = get_next_day_str(skip_weekends=True)
            day_of_week = datetime.strptime(next_date, "%d-%m-%Y").strftime("%A")
            date_span.string = f"{next_date} - {day_of_week}"

    save_html(soup)
    git_push()

# ---------------------------
# Scheduled Jobs
# ---------------------------
def update_am_result():
    result = str(random.randint(0, 99)).zfill(2)
    update_html(new_result=result, period="am")
    print(f"✅ AM result updated: {result}")

def update_pm_result():
    result = str(random.randint(0, 99)).zfill(2)
    update_html(new_result=result, period="pm")
    print(f"✅ PM result updated: {result}")

def weekday_evening_update():
    updates = {
        "one-chain": calculate_one_chain(),
        "not-broken": calculate_not_broken(),
        "one-kwet": "",
        "shwe-pat-tee": "",
        "punch": ""
    }
    update_html(updates=updates)
    print("🌙 Weekday evening update done.")

def sunday_update():
    updates = {"mwe-ga-nan": calculate_mwe_ga_nan()}
    update_html(updates=updates)
    print("☀️ Sunday Mwe Ga Nan updated.")

def advance_date_job():
    update_html(advance_date=True)
    print("📅 Date advanced for next draw.")

# ---------------------------
# Missed Schedule Recovery
# ---------------------------
last_run = {}

def check_missed_jobs():
    now = datetime.now(yangon_tz)

    jobs = {
        "am": (now.replace(hour=12, minute=1, second=0, microsecond=0), update_am_result),
        "pm": (now.replace(hour=16, minute=30, second=0, microsecond=0), update_pm_result),
        "evening": (now.replace(hour=20, minute=0, second=0, microsecond=0), weekday_evening_update),
        "advance": (now.replace(hour=20, minute=1, second=0, microsecond=0), advance_date_job),
        "sunday": (now.replace(hour=17, minute=0, second=0, microsecond=0), sunday_update),
    }

    for key, (scheduled_time, func) in jobs.items():
        if now > scheduled_time and last_run.get(key) != now.date():
            func()
            last_run[key] = now.date()
            print(f"⚡ Recovered missed job: {key}")

# ---------------------------
# Scheduler Setup
# ---------------------------
schedule.every().day.at("12:01").do(update_am_result)
schedule.every().day.at("16:30").do(update_pm_result)

schedule.every().monday.at("20:00").do(weekday_evening_update)
schedule.every().tuesday.at("20:00").do(weekday_evening_update)
schedule.every().wednesday.at("20:00").do(weekday_evening_update)
schedule.every().thursday.at("20:00").do(weekday_evening_update)
schedule.every().friday.at("20:00").do(weekday_evening_update)

schedule.every().sunday.at("17:00").do(sunday_update)

schedule.every().monday.at("20:01").do(advance_date_job)
schedule.every().tuesday.at("20:01").do(advance_date_job)
schedule.every().wednesday.at("20:01").do(advance_date_job)
schedule.every().thursday.at("20:01").do(advance_date_job)
schedule.every().friday.at("20:01").do(advance_date_job)

schedule.every().hour.do(check_missed_jobs)

# ---------------------------
# Main Loop
# ---------------------------
if __name__ == "__main__":
    print("🚀 Scheduler with GitHub sync started...")
    while True:
        schedule.run_pending()
        time.sleep(30)
